# 扩散模型DDPM
## 结构：级联去噪模型
## 步骤：
1. **前向扩散**:前向过程是加噪的过程，前向过程中图像 $x_t$ 只和上一时刻的 $x_{t-1}$ 有关, 该过程可以视为马尔科夫过程
2. **反向去噪**:逆向过程是去噪的过程，如果得到好的逆向过程就可以通过随机噪声 逐步还原出一张图像。DDPM使用神经网络  拟合逆向过程  。
![image.png](https://raw.githubusercontent.com/lishiyu2006/picgo/main/cdning/202509262221782.png)
attention：
1.无论是前向过程还是反向过程都是一个参数化的[马尔可夫链](https://zhuanlan.zhihu.com/p/448575579)（Markov chain）（即当经过一定的训练负责还原或者加噪1%的这部分），其中反向过程可用于生成数据样本（它的作用类似GAN中的生成器，只不过GAN生成器会有维度变化，而DDPM的反向过程没有维度变化）

2.1) $q$ 通常用来表示一个**预先定义好的、固定的、不需要学习**的概率分布。它代表了某种“事实”或“数学真理”。例如:
$q(x_t | x_{t-1})$ (前向过程)
$q(x_{t-1} | x_t, x_0)$ (真实的逆向过程 - 条件)
$q(x_{t-1} | x_t)$ (真实的逆向过程 - 无条件)

2.2) $p$ (通常带有下标 $θ$) 用来表示一个**由神经网络定义的、需要通过训练学习**的概率分布。它是一个**近似模型**。例如:
$p_θ(x_{t-1} | x_t)$ (学习的逆向过程)

### 前提
任何一张图像 x（无论是 x_0, x_t 还是噪声 ε）都会被转换成一个张量。
一个典型的图像张量包含以下维度信息：

**(Batch Size, Channels, Height, Width)**

- **Batch Size (B)**：一批处理多少张图片。在训练时通常大于1（如16, 32），在生成单张图时为1。
    
- **Channels (C)**：颜色通道。
    
    - 对于彩色图（RGB），Channels = 3。
        
    - 对于灰度图，Channels = 1。
        
- **Height (H)**：图像的高度（像素数）。
    
- **Width (W)**：图像的宽度（像素数）。

#### 一.前向过程

前向过程是加噪的过程,前向过程的图像 $x_t$ 值和上一时刻的 $x_{t-1}$ 有关,该工程可以视为马尔科过程
$q(x_{1:T}|x_0) = \prod_{t=1}^{T} q(x_t|x_{t-1})$
$q(x_t|x_{t-1}) = \mathcal{N}(x_t; \sqrt{1 - \beta_t}x_{t-1}, \beta_t I)$

$q(x_{1:T}|x_0)$表示的是从原始图像 $x_0$ 开始，经过 $T$ 步加噪过程后得到噪声图像 $x_t$ 的概率分布。
每一步 $q(x_t|x_{t-1})$ 表示:第 $t$ 步的噪声图像 $x_t$ ，是通过将第 $t-1$ 步的图像 $x_{t-1}$ 的像素值稍微缩小一点，然后给每个像素独立地添加一个强度为 $\beta_t$ 的[高斯噪声](../高斯噪声.md)得到的。

#### 二.逆向过程

逆向过程是去噪的过程,如果得到逆向过程 $q(x_{t-1}|x_t)$ ，就可以通过随机噪声 逐步还原出一张图像。DDPM使用神经网络  拟合逆向过程  。
$q(x_{t-1}|x_t, x_0) = N(x_{t-1} | \tilde{\mu}_t(x_t, x_0), \tilde{\beta}_t I)$ ,可以推导出:
$p_θ(x_{t-1}|x_t) = N(x_{t-1} | \mu_θ(x_t, t), Σ_θ(x_t, t))$

这里的均值 $\tilde{\mu}_t$ 和方差 $\tilde{\beta}_t$ 是属于**逆向过程后验分布**（reverse process posterior）的参数，它们是通过数学推导得出的“真实”去噪步骤的参数，而不是我们之前在前向（加噪）过程中定义的原始参数 $β_t$。

|      | 第一行                            | 第二行                            |
| ---- | ------------------------------ | ------------------------------ |
| 角色   | 标准答案 **(Ground Truth)**        | 学生的回答 **(Model's Prediction)** |
| 前提条件 | 知道问题 $(x_t)$ 和答案 $(x_0)$       | 只知道问题 $(x_t)$                  |
| 均值   | $\tilde{\mu}_t$ (波浪号): 真实的均值   | $\mu_θ$: 预测的均值                 |
| 方差   | $\tilde{\beta}_t$ (波浪号): 真实的方差 | $Σ_θ$: 预测的方差                   |

DDPM 论文中通过神经网络（通常是 U-Net）拟合噪声预测模型 $ε_θ$ ，从而间接得到均值 $\mu_θ$​，以计算 $x_{t-1}$ 。方差通常是固定的，并未直接通过神经网络拟合，而是由扩散过程的参数决定。
$μ_θ = (1 / sqrt(α_t)) * (x_t - ((1 - α_t) / sqrt(1 - ᾱ_t)) * ε_θ(x_t, t))$

### 可以使用的神经网络：U-Net，Transformer
这里采用Unet实现正向的预测，整个训练过程其实就是在训练Unet网络的参数